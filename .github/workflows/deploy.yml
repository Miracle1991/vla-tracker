name: Deploy to GitHub Pages

on:
  schedule:
    # 每周一 UTC 时间 8:00 运行（北京时间 16:00），更新上一周的内容
    - cron: '0 8 * * 1'
  workflow_dispatch:  # 允许手动触发
    inputs:
      refresh_all:
        description: '是否刷新 2025年8月之后的所有周（代码更新时使用）'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来创建 gh-pages 分支
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Checkout gh-pages (for history)
      uses: actions/checkout@v3
      continue-on-error: true
      with:
        ref: gh-pages
        path: prev_pages
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Restore weekly history (weeks/*.json)
      run: |
        mkdir -p data/weeks
        # 优先从 prev_pages/weeks 恢复（gh-pages 分支的历史数据）
        if [ -d "prev_pages/weeks" ] && [ "$(ls -A prev_pages/weeks/*.json 2>/dev/null)" ]; then
          cp -a prev_pages/weeks/*.json data/weeks/ || true
          echo "✓ Restored week files from prev_pages/weeks:"
          ls -la data/weeks/ | head -10
        else
          echo "No previous gh-pages history found in prev_pages/weeks"
        fi
        # 如果 data/weeks 仍然为空，尝试从 docs/weeks 恢复（如果存在）
        if [ ! "$(ls -A data/weeks/*.json 2>/dev/null)" ] && [ -d "docs/weeks" ] && [ "$(ls -A docs/weeks/*.json 2>/dev/null)" ]; then
          echo "data/weeks is empty, trying to restore from docs/weeks..."
          cp -a docs/weeks/*.json data/weeks/ || true
          echo "✓ Restored week files from docs/weeks:"
          ls -la data/weeks/ | head -10
        fi
        # 确保 data/weeks 目录存在
        if [ ! -d "data/weeks" ]; then
          mkdir -p data/weeks
        fi
        echo "Final data/weeks contents:"
        ls -la data/weeks/ || echo "data/weeks is empty (will be populated by crawler)"
    
    - name: Check if initial deployment (need to refresh all weeks)
      id: check_initial
      run: |
        # 检查 data/weeks 是否有数据
        if [ -z "$(ls -A data/weeks/*.json 2>/dev/null)" ]; then
          echo "is_initial=true" >> $GITHUB_OUTPUT
          echo "首次部署：data/weeks 为空，需要刷新 2025年8月之后的所有周"
        else
          echo "is_initial=false" >> $GITHUB_OUTPUT
          echo "非首次部署：data/weeks 已有数据"
        fi
    
    - name: Refresh all weeks since August 2025 (initial deployment or code update)
      if: ${{ steps.check_initial.outputs.is_initial == 'true' || github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.refresh_all == 'true') }}
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
        SEARCH_QUERY: ${{ secrets.SEARCH_QUERY }}
        MAX_RESULTS_PER_SITE: ${{ secrets.MAX_RESULTS_PER_SITE }}
        DATA_DIR: data
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        if [ "${{ steps.check_initial.outputs.is_initial }}" == "true" ]; then
          echo "首次部署：刷新 2025年8月之后的所有周的数据..."
        else
          echo "代码更新：刷新 2025年8月之后的所有周的数据..."
        fi
        python refresh_weeks.py || echo "刷新失败，但继续执行"
      continue-on-error: true

    - name: Update last week (weekly schedule)
      if: ${{ (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.refresh_all != 'true')) && steps.check_initial.outputs.is_initial != 'true' }}
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
        SEARCH_QUERY: ${{ secrets.SEARCH_QUERY }}
        MAX_RESULTS_PER_SITE: ${{ secrets.MAX_RESULTS_PER_SITE }}
        DATA_DIR: data
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        echo "每周一自动更新，更新上一周的内容..."
        python run_daily.py || echo "更新失败，但继续生成静态页面"
      continue-on-error: true
    
    - name: Generate static HTML
      run: |
        echo "Checking data before generating static HTML:"
        ls -la data/weeks/ || echo "data/weeks is empty"
        echo "Running generate_static.py..."
        python generate_static.py
        echo "Verifying generated files:"
        ls -la docs/ || echo "docs directory does not exist"
    
    - name: List docs directory
      run: |
        echo "Contents of docs directory:"
        ls -la docs/ || echo "docs directory does not exist"
        if [ -f docs/index.html ]; then
          echo "✓ index.html exists"
          head -20 docs/index.html
        else
          echo "✗ index.html does not exist"
        fi
        echo "---"
        echo "Contents of docs/weeks (if any):"
        ls -la docs/weeks/ || true
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        cname: false
        keep_files: false
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
