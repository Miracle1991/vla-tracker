name: Deploy to GitHub Pages

on:
  schedule:
    # 每天 UTC 时间 8:00 运行（北京时间 16:00）
    - cron: '0 8 * * *'
  workflow_dispatch:  # 允许手动触发
    inputs:
      backfill_weeks:
        description: '回填历史周数量（0=不回填）'
        required: false
        default: '0'
      since:
        description: '起始日期 YYYY-MM-DD（留空使用 2025-10-01 或仓库配置）'
        required: false
        default: ''
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来创建 gh-pages 分支
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Checkout gh-pages (for history)
      uses: actions/checkout@v3
      continue-on-error: true
      with:
        ref: gh-pages
        path: prev_pages
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Restore weekly history (weeks/*.json)
      run: |
        if [ -d "prev_pages/weeks" ]; then
          mkdir -p data/weeks
          cp -a prev_pages/weeks/*.json data/weeks/ || true
          echo "Restored week files:"
          ls -la data/weeks || true
        else
          echo "No previous gh-pages history found (first deploy?)"
        fi
    
    - name: Run daily crawler
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
        SEARCH_QUERY: ${{ secrets.SEARCH_QUERY }}
        MAX_RESULTS_PER_SITE: ${{ secrets.MAX_RESULTS_PER_SITE }}
        DATA_DIR: data
        USE_DUCKDUCKGO: "False"
        USE_SERPAPI: "False"
      run: |
        python run_daily.py || echo "抓取失败，但继续生成静态页面"
      continue-on-error: true

    - name: Backfill weekly data (optional)
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.backfill_weeks != '' && github.event.inputs.backfill_weeks != '0' }}
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
        SEARCH_QUERY: ${{ secrets.SEARCH_QUERY }}
        MAX_RESULTS_PER_SITE: ${{ secrets.MAX_RESULTS_PER_SITE }}
        DATA_DIR: data
        USE_DUCKDUCKGO: "False"
        USE_SERPAPI: "False"
      run: |
        MAX_WEEKS="${{ github.event.inputs.backfill_weeks }}"
        SINCE="${{ github.event.inputs.since }}"
        if [ -z "$SINCE" ]; then SINCE="2025-10-01"; fi
        echo "Backfilling weeks: $MAX_WEEKS since $SINCE"
        python backfill_weeks.py --since "$SINCE" --max-weeks "$MAX_WEEKS"
    
    - name: Generate static HTML
      run: |
        python generate_static.py
    
    - name: List docs directory
      run: |
        echo "Contents of docs directory:"
        ls -la docs/ || echo "docs directory does not exist"
        if [ -f docs/index.html ]; then
          echo "✓ index.html exists"
          head -20 docs/index.html
        else
          echo "✗ index.html does not exist"
        fi
        echo "---"
        echo "Contents of docs/weeks (if any):"
        ls -la docs/weeks/ || true
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        cname: false
        keep_files: false
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
